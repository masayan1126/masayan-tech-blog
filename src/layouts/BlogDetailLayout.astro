---
import FormattedDate from "@/components/FormattedDate.astro";
import "@fontsource-variable/noto-sans-jp";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getArticlesByCategory } from "@/libs/microcms/blog";
import Link from "@/components/Link/Link.astro";
import buildFilter from "@/libs/microcms/buildFilter";
import { Icon } from "astro-icon";
import { BlogListLink } from "@/features/Blog/List/BlogListLink";
import BlogDetailProfileCard from "@/features/Blog/Detail/BlogDetailProfileCard.astro";
import { SITE_DOMAIN } from "@/constants/url";
import { ARTICLES_PATH } from "@/features/Blog/List/constants/path";
import type { Article } from "@/libs/microcms/blog";
import ScrollToTop from "@/components/ScrollToTop.astro";
import { LinkCardReplacer } from "@/features/LinkCard/LinkCardReplacer";

type Props = Article;

const { title, description, publishedAt, revisedAt, category, youtube_link } = Astro.props;
const { slug } = Astro.params;




const catetoryIds = category.map(({ id }) => id);
const filter = buildFilter("categoryId", catetoryIds);
const relatedPostsRes = await getArticlesByCategory(filter);
const relatedRandomPosts = [...relatedPostsRes.contents].sort(() => {
  return Math.random() - 0.5;
});

console.log(youtube_link);

const breadCrumbsList = [
  {
    name: "„Éñ„É≠„Ç∞Ë®ò‰∫ã‰∏ÄË¶ß",
    path: ARTICLES_PATH,
  },
  {
    name: title,
    path: `/blog/${slug}/`,
  },
];
---

<BaseLayout
  {title}
  {description}
  context={"blog"}
  {breadCrumbsList}
>
  <div class="blog-detail-wrapper">
    <div class="main">
      <div class="blog-detail-header">
        <h1 class="article-title">
          {title}
        </h1>

        <div class="flex flex-col gap-2">
          <div>
            <Icon name="noto:calendar" class="w-5 h-5 mr-1 inline-block align-middle text-blue-300" />
            ÂÖ¨ÈñãÊó•
            <FormattedDate date={new Date(publishedAt)} />
          </div>
          <div>
            <Icon name="noto:pen" class="w-5 h-5 mr-1 inline-block align-middle text-green-300" />
            ÊúÄÁµÇÊõ¥Êñ∞Êó•
            <FormattedDate date={new Date(revisedAt)} />
          </div>
        </div>
      </div>
      {youtube_link && (
        <>
          <p class="youtube-label">„Åì„ÅÆÂÜÖÂÆπ„ÅØYOUTUBEÂãïÁîª„Åß„ÇÇ„ÅîË¶ß„ÅÑ„Åü„Å†„Åë„Åæ„Åô</p>
          <div class="youtube-embed-container mt-8">
            <iframe
              width="100%"
              height="315"
              src={youtube_link.replace('watch?v=', 'embed/')}
              title="YouTube video player"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
            ></iframe>
          </div>
        </>
      )}
      <article>
        <slot />
      </article>
      <LinkCardReplacer client:load />
      <ScrollToTop />
    </div>
    <aside>
      <div class="grid gap-20">
        <div>
          <p class="aside-title">„Ç´„ÉÜ„Ç¥„É™</p>
          <div class="flex flex-wrap gap-2">
            {category.map(({ id, name }) => (
              <a
                href={`/category/${id}${ARTICLES_PATH}`}
                class="inline-block px-3 py-1 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/30 hover:border-blue-500/50 rounded-lg text-sm text-white transition-all duration-200 hover:scale-105"
              >
                {name}
              </a>
            ))}
          </div>
        </div>
        <div>
          <p class="aside-title">„Åì„ÅÆË®ò‰∫ã„Çí„Ç∑„Çß„Ç¢„Åô„Çã</p>
          <Link
            href={`http://twitter.com/share?url=${SITE_DOMAIN}/blog/${slug}&via=masayanishigaki&text=${title}`}
            target="_blank"
          >
            <Icon name="logos:twitter" class="w-8 inline-block mr-2" />
          </Link>
          <Link
            href={`http://b.hatena.ne.jp/add?mode=confirm&url=${SITE_DOMAIN}/blog/${slug}&title=${title}`}
            target="_blank"
          >
            <Icon
              name="simple-icons:hatenabookmark"
              class="w-8 inline-block mr-2"
            />
          </Link>
        </div>

        <div class="">
          <p class="aside-title">„Éñ„É≠„Ç∞ÁÆ°ÁêÜ‰∫∫</p>
          <BlogDetailProfileCard />
        </div>

        <div>
          <p class="aside-title">Èñ¢ÈÄ£Ë®ò‰∫ã</p>
          <div class="gap-10 grid grid-cols-1">
            {
              relatedRandomPosts.map(
                (post, i) =>
                  i < 16 && (
                    <div>
                      <p class={"mb-2"}>
                        <Link href={`/blog/${post.id}`} color="white">
                          {post.title}
                        </Link>
                      </p>
                      <div class="flex flex-wrap gap-1 mb-2">
                        {post.category.map((c) => (
                          <a
                            href={`/category/${c.id}${ARTICLES_PATH}`}
                            class="inline-block px-2 py-1 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/30 hover:border-blue-500/50 rounded text-xs text-white transition-all duration-200 hover:scale-105"
                          >
                            {c.name}
                          </a>
                        ))}
                      </div>
                      <p class="mt-2 text-sm">
                        <FormattedDate date={new Date(post.publishedAt)} />
                      </p>
                      <div class="mt-3">
                        <BlogListLink
                          href={`/blog/${post.id}/`}
                          className="text-link"
                        >
                          „Åì„ÅÆË®ò‰∫ã„ÇíË™≠„ÇÄ
                        </BlogListLink>
                      </div>
                    </div>
                  )
              )
            }
          </div>
        </div>
      </div>
    </aside>
  </div>
</BaseLayout>
<!-- MEMO:ÂãïÁöÑ„Å´ÂèñÂæó„Åó„ÅüË®ò‰∫ã„ÅÆ„Çø„Ç∞„Å´„Çπ„Çø„Ç§„É´„ÇíÂΩì„Å¶„Çã„Å´„ÅØ„ÄÅgloba„Å´„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã -->
<style is:global>
  article {
    width: 100%;
    overflow-x: scroll;
  }

  article h1::before {
    content: "üî•";
  }

  .article-title {
    @apply text-xl sm:text-2xl md:text-3xl font-bold mb-2 inline-block;
  }

  .toc-title {
    @apply text-2xl font-bold mt-14 mb-2;
  }

  .toc-title::before {
    content: "üöÄ";
    padding-right: 5px;
  }

  article h2 {
    @apply text-2xl font-bold mt-14 mb-2;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
  }

  article h2::before {
    content: "üöÄ";
    padding-right: 5px;
  }

  article h3 {
    @apply text-lg font-bold mt-8 mb-2;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
  }

  article h4 {
    @apply font-bold mt-8 mb-2;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
  }

  article h5 {
    @apply font-bold mt-8 mb-2;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
  }

  article p {
    @apply m-0;
  }

  article iframe {
    @apply mt-2;
    border-radius: 12px;
    box-shadow: 
      0 8px 24px rgba(0, 0, 0, 0.4),
      0 2px 6px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  article img {
    @apply my-6;
    border-radius: 12px;
    box-shadow: 
      0 10px 30px rgba(0, 0, 0, 0.5),
      0 1px 8px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    max-width: 100%;
    height: auto;
  }

  article img:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 
      0 20px 40px rgba(0, 0, 0, 0.6),
      0 4px 12px rgba(0, 0, 0, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.15);
  }

  article ul {
    @apply list-disc px-8 py-4;
  }

  article ol {
    @apply list-decimal px-8 py-4;
  }

  article pre {
    @apply mt-6 mb-10;
    border-radius: 12px;
    box-shadow: 
      0 8px 24px rgba(0, 0, 0, 0.4),
      0 2px 6px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
    overflow-x: auto;
  }

  article pre:hover {
    box-shadow: 
      0 12px 32px rgba(0, 0, 0, 0.5),
      0 4px 8px rgba(0, 0, 0, 0.4);
    transform: translateY(-2px);
  }

  /* Normal links (excluding link cards) */
  article a:not(.link-card) {
    color: rgb(146, 180, 237);
    padding: 10px 0;
  }

  /* Link Card Styles - supports both <a> and <span> */
  article .link-card {
    display: flex !important;
    align-items: stretch !important;
    text-decoration: none !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    margin: 1.5rem 0 !important;
    background: rgba(255, 255, 255, 0.02) !important;
    transition: all 0.3s ease !important;
    box-shadow:
      0 4px 12px rgba(0, 0, 0, 0.3),
      0 1px 3px rgba(0, 0, 0, 0.2) !important;
    padding: 0 !important;
    color: inherit !important;
  }

  article .link-card:hover {
    background: rgba(255, 255, 255, 0.05) !important;
    border-color: rgba(146, 180, 237, 0.4) !important;
    transform: translateY(-2px) !important;
    box-shadow:
      0 8px 24px rgba(0, 0, 0, 0.4),
      0 2px 6px rgba(146, 180, 237, 0.2) !important;
  }

  article .link-card .link-card-thumbnail {
    flex-shrink: 0;
    width: 200px;
    min-height: 120px;
    background: rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  article .link-card .link-card-thumbnail img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    margin: 0 !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    padding: 0 !important;
  }

  article .link-card .link-card-thumbnail img:hover {
    transform: none !important;
    box-shadow: none !important;
  }

  article .link-card .link-card-content {
    flex: 1;
    padding: 1.25rem 1.5rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 0.75rem;
    min-width: 0;
  }

  article .link-card .link-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  article .link-card .link-card-site-name {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 500;
  }

  article .link-card .link-card-title {
    font-size: 1rem;
    color: rgb(146, 180, 237);
    font-weight: 600;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Mobile Responsive */
  @media (max-width: 640px) {
    article .link-card {
      flex-direction: column !important;
    }

    article .link-card .link-card-thumbnail {
      width: 100% !important;
      min-height: 180px !important;
      max-height: 200px !important;
    }

    article .link-card .link-card-content {
      padding: 1.25rem !important;
    }
  }

  article p:has(.warning) {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    padding: 1.5rem 1.5rem 1.5rem 3.5rem;
    border-radius: 8px;
    position: relative;
    margin: 1.5rem 0;
  }

  article p:has(.warning)::before {
    content: "‚ö†Ô∏è";
    position: absolute;
    left: 1.2rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
  }

  article p:has(.info) {
    background: rgba(76, 175, 80, 0.1);
    border: 1px solid rgba(76, 175, 80, 0.3);
    padding: 1.5rem 1.5rem 1.5rem 3.5rem;
    border-radius: 8px;
    position: relative;
    margin: 1.5rem 0;
  }

  article p:has(.info)::before {
    content: "‚ÑπÔ∏è";
    position: absolute;
    left: 1.2rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
  }

  article .iframely-embed {
    @apply my-6;
  }

  article table {
    @apply my-6;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 
      0 8px 24px rgba(0, 0, 0, 0.4),
      0 2px 6px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  article th {
    background: linear-gradient(135deg, rgba(96, 165, 250, 0.2), rgba(59, 130, 246, 0.15));
    padding: 1rem;
    border-bottom: 2px solid rgba(96, 165, 250, 0.3);
    font-weight: 600;
    text-align: left;
  }

  article td {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  article tr:hover {
    background: rgba(255, 255, 255, 0.03);
    transition: background 0.2s ease;
  }

  .youtube-embed-container {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 */
    height: 0;
    margin-bottom: 2rem;
    margin-top: 2rem;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 
      0 12px 36px rgba(0, 0, 0, 0.5),
      0 4px 12px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
  }
  
  .youtube-embed-container:hover {
    transform: translateY(-4px);
    box-shadow: 
      0 20px 48px rgba(0, 0, 0, 0.6),
      0 8px 16px rgba(0, 0, 0, 0.4);
    border-color: rgba(255, 255, 255, 0.15);
  }
  
  .youtube-embed-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }
  .youtube-label {
    margin-top: 2rem;
    font-size: 1rem;
    text-align: left;
    color: #fff;
    font-weight: bold;
    letter-spacing: 0.05em;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, rgba(255, 0, 0, 0.15), rgba(255, 0, 0, 0.05));
    border-left: 4px solid #ff0000;
    border-radius: 8px;
    box-shadow: 
      0 4px 12px rgba(255, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .youtube-label::before {
    content: "‚ñ∂";
    color: #ff0000;
    font-size: 1.2em;
  }

  /* Link Card Styles */
  .link-card-wrapper {
    @apply my-6;
  }

  .link-card-container {
    display: block;
    text-decoration: none;
    color: inherit;
    transition: all 0.3s ease;
  }

  .link-card {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow:
      0 4px 12px rgba(0, 0, 0, 0.3),
      0 1px 3px rgba(0, 0, 0, 0.2);
  }

  .link-card:hover {
    transform: translateY(-2px);
    border-color: rgba(96, 165, 250, 0.5);
    background: rgba(255, 255, 255, 0.05);
    box-shadow:
      0 8px 24px rgba(0, 0, 0, 0.4),
      0 2px 6px rgba(0, 0, 0, 0.3);
  }

  .link-card-thumbnail {
    flex-shrink: 0;
    width: 150px;
    height: 150px;
    border-radius: 8px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.2);
  }

  .link-card-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    margin: 0 !important;
    box-shadow: none !important;
    border: none !important;
    transition: transform 0.3s ease;
  }

  .link-card:hover .link-card-thumbnail img {
    transform: scale(1.05);
  }

  .link-card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 0;
  }

  .link-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .link-card-favicon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .link-card-site-name {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    font-weight: 500;
  }

  .link-card-title {
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.4;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .link-card-title::before {
    content: none !important;
  }

  .link-card-description {
    font-size: 0.875rem;
    line-height: 1.5;
    color: rgba(255, 255, 255, 0.7);
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  /* Loading skeleton */
  .link-card-skeleton {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
  }

  .skeleton-thumbnail {
    width: 150px;
    height: 150px;
    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0.05) 0%,
      rgba(255, 255, 255, 0.1) 50%,
      rgba(255, 255, 255, 0.05) 100%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    border-radius: 8px;
  }

  .skeleton-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .skeleton-title {
    height: 1.25rem;
    width: 80%;
    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0.05) 0%,
      rgba(255, 255, 255, 0.1) 50%,
      rgba(255, 255, 255, 0.05) 100%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    border-radius: 4px;
  }

  .skeleton-description {
    height: 3rem;
    width: 100%;
    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0.05) 0%,
      rgba(255, 255, 255, 0.1) 50%,
      rgba(255, 255, 255, 0.05) 100%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    border-radius: 4px;
  }

  .skeleton-site {
    height: 0.875rem;
    width: 40%;
    background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0.05) 0%,
      rgba(255, 255, 255, 0.1) 50%,
      rgba(255, 255, 255, 0.05) 100%
    );
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    border-radius: 4px;
  }

  @keyframes skeleton-loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }

  /* Fallback styles */
  .link-card-fallback {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    transition: all 0.3s ease;
  }

  .link-card-fallback:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(96, 165, 250, 0.3);
  }

  .fallback-icon {
    font-size: 1.5rem;
  }

  .fallback-url {
    font-size: 0.875rem;
    color: rgb(146, 180, 237);
    word-break: break-all;
  }

  /* Responsive styles */
  @media (max-width: 640px) {
    .link-card {
      flex-direction: column;
    }

    .link-card-thumbnail {
      width: 100%;
      height: 200px;
    }
  }
</style>

<style>
  .blog-detail-wrapper {
    min-height: 100vh;
    width: 100%;
    display: grid;
    grid-template:
      "blog-detail-header blog-detail-header blog-detail-header" 50px
      "center center right " 1fr
      "footer footer footer" 100px
      / auto 1fr 250px;
    grid-gap: 10px 100px;
  }

  .blog-detail-header {
    grid-area: blog-detail-header;
  }

  .main {
    grid-area: center;
  }

  nav {
    grid-area: left;
  }

  aside {
    grid-area: right;
  }

  .aside-title {
    @apply text-xl font-bold mb-4;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
  }

  .footer {
    grid-area: footer;
  }

  @media (max-width: 1024px) {
    .blog-detail-wrapper {
      grid-template:
        "blog-detail-header blog-detail-header blog-detail-header" 70px
        "center center center " 1fr
        "right  right  right " auto
        / 1fr;
      grid-gap: 10px 100px;
    }
  }
</style>
