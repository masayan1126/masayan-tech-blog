---
import type { Article } from "@/libs/microcms/blog";
import FormattedDate from "@/components/FormattedDate.astro";
import { Icon } from "astro-icon";
import { optimizeImageUrl } from "@/utils/imageOptimizer";

type Props = {
  post: Article;
};

const { post } = Astro.props;

// 読了時間を計算（日本語は1分あたり約500文字）
const calculateReadingTime = (content: string): number => {
  const textOnly = content.replace(/<[^>]*>/g, '');
  const charCount = textOnly.length;
  const readingTime = Math.ceil(charCount / 500);
  return Math.max(1, readingTime);
};

// 概要を指定文字数で切り詰め
const truncateDescription = (text: string, maxLength: number): string => {
  if (text.length <= maxLength) return text;
  return text.slice(0, maxLength) + '...';
};

const readingTime = calculateReadingTime(post.content);
---

<div class="modern-blog-card-astro">
  <a href={`/blog/${post.id}/`} class="card-link">
    {/* アイキャッチ画像 */}
    {post.eyecatch && (
      <div class="card-image-container">
        <picture>
          <source
            srcset={`${optimizeImageUrl(post.eyecatch.url, { width: 400, format: 'avif', quality: 50 })} 400w, ${optimizeImageUrl(post.eyecatch.url, { width: 600, format: 'avif', quality: 50 })} 600w`}
            sizes="(max-width: 768px) 400px, 600px"
            type="image/avif"
          />
          <source
            srcset={`${optimizeImageUrl(post.eyecatch.url, { width: 400, format: 'webp', quality: 55 })} 400w, ${optimizeImageUrl(post.eyecatch.url, { width: 600, format: 'webp', quality: 55 })} 600w`}
            sizes="(max-width: 768px) 400px, 600px"
            type="image/webp"
          />
          <img
            src={optimizeImageUrl(post.eyecatch.url, { width: 600, quality: 60 })}
            width={600}
            height={Math.round(600 * post.eyecatch.height / post.eyecatch.width)}
            alt={post.title}
            class="card-image"
            loading="lazy"
            decoding="async"
          />
        </picture>
      </div>
    )}

    <div class="card-content">
        {/* タイトル */}
        <h2 class="card-title">{post.title}</h2>

        {/* 記事概要 */}
        {post.description && (
          <p class="card-description">
            {truncateDescription(post.description, 80)}
          </p>
        )}

        {/* カテゴリバッジ */}
        <div class="flex flex-wrap gap-2 mb-3">
          {post.category.map((c) => (
            <span class="category-badge">
              {c.name}
            </span>
          ))}
        </div>

        {/* メタ情報（公開日・読了時間） */}
        <div class="card-meta">
          <div class="meta-item">
            <Icon name="ph:calendar-bold" class="meta-icon" />
            <FormattedDate date={new Date(post.publishedAt)} />
          </div>
          <div class="meta-item">
            <Icon name="ph:clock-bold" class="meta-icon" />
            <span>約{readingTime}分で読めます</span>
          </div>
        </div>
      </div>
  </a>
</div>

<style>
  .modern-blog-card-astro {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    background: #2a2a2a;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .modern-blog-card-astro:hover {
    border: 1px solid rgba(var(--color-primary-rgb), 0.4);
    background: #2f2f2f;
  }

  .card-image-container {
    width: 100%;
    overflow: hidden;
  }

  .card-image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s ease;
  }

  .modern-blog-card-astro:hover .card-image {
    transform: scale(1.05);
  }


  .category-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background-color: rgba(var(--color-primary-rgb), 0.2);
    border: 1px solid rgba(var(--color-primary-rgb), 0.4);
    border-radius: 0.25rem;
    font-size: 0.75rem;
    color: var(--color-primary);
  }
  
  .card-content {
    position: relative;
    z-index: 2;
    padding: 24px;
  }
  
  .card-title {
    font-size: 1.125rem;
    font-weight: bold;
    margin: 0 0 0.75rem 0;
    color: var(--text-color);
    transition: color 0.2s ease;
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .modern-blog-card-astro:hover .card-title {
    color: var(--color-primary);
  }
  
  .card-description {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.6);
    margin: 0 0 0.75rem 0;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }
  
  .meta-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    color: var(--color-primary);
  }
  
  :global(.card-link) {
    display: block;
    text-decoration: none;
    color: inherit;
  }
</style>
