---
import HeaderLink from "@/features/Header/HeaderLink.astro";
import Link from "@/components/Link/Link.astro";

import { headerLinkOf } from "./headerLinkMapper";
import { Image } from "astro:assets";
import { ARTICLES_PATH } from "@/features/Blog/List/constants/path";
import { SITE_TITLE } from "@/constants/meta";
import profileImage from "@/assets/images/miyabiya.webp";

interface Props {
  context: string;
}

const { context } = Astro.props;

const headerLinks = headerLinkOf(context);
---

<header class="mx-auto py-3 lg:pt-3 lg:px-0 fixed top-0 left-0 w-full z-50 bg-[#1a1a1a] border-b border-white/10">
  <div class="flex justify-between items-center">
    <Link href={ARTICLES_PATH} class="site-title-link">
      <div class="flex items-center logo-container">
        <Image
          src={profileImage}
          width={32}
          height={32}
          alt={"西垣雅矢のプロフィール画像"}
          format="avif"
          class="mr-3 hidden md:block rounded-full border border-white/20"
        />
        <h2 class="headerTitle">
          <span class="prompt-symbol">&gt;</span>
          <span id="typing-text" class="typing-text" data-text={SITE_TITLE}></span>
          <span class="typing-cursor"></span>
        </h2>
      </div>
    </Link>

    <nav class="hidden md:flex items-center space-x-3">
      {
        headerLinks.map((link) => (
          <HeaderLink href={link.href} iconName={link.iconName}>
            {link.text}
          </HeaderLink>
        ))
      }
    </nav>
  </div>
  <style>
    header {
      margin: 0 0 1em 0;
      opacity: 0.95;
    }

    header > div {
      @apply mx-auto;
      width: 90%;
      max-width: 1400px;
    }

    .logo-container {
      padding: 0.5rem;
      border-radius: 8px;
      transition: background-color 0.2s ease;
    }

    .site-title-link:hover .logo-container {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .headerTitle {
      @apply text-lg sm:text-xl md:text-2xl transition-all duration-200;
      display: flex;
      align-items: center;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing: -0.02em;
      color: #e0e0e0;
    }

    .prompt-symbol {
      color: var(--color-primary);
      margin-right: 0.5rem;
      font-weight: bold;
    }

    .typing-text {
      display: inline-block;
      white-space: pre;
    }

    /* 最後のピリオドをプライマリカラーに */
    .typing-text :global(.title-dot) {
      color: var(--color-primary);
    }

    .typing-cursor {
      display: inline-block;
      width: 10px;
      height: 1.2em;
      background-color: var(--color-primary);
      margin-left: 2px;
      animation: blink 1s step-end infinite;
      vertical-align: middle;
    }

    .typing-cursor.hidden {
      opacity: 0;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    
    :global(.site-title-link) {
      @apply transition-all duration-200 ease-out;
      text-decoration: none;
    }
    
    :global(.site-title-link:hover .headerTitle) {
      color: #ffffff;
    }
    
    /* 超小画面対応 (439px以下) */
    @media (max-width: 439px) {
      header > div {
        width: 95%;
        padding: 0 0.5rem;
      }
      
      .headerTitle {
        @apply text-base;
        font-size: 1.2rem;
      }

      .prompt-symbol {
        margin-right: 0.25rem;
      }
    }
    
    /* 極小画面対応 (360px以下) */
    @media (max-width: 360px) {
      header > div {
        width: 98%;
        padding: 0 0.25rem;
      }
      
      .headerTitle {
        font-size: 0.9rem;
      }
    }
  </style>
</header>

<script>
  function initTypingAnimation() {
    const typingElement = document.getElementById('typing-text');
    const cursorElement = document.querySelector('.typing-cursor');
    
    if (!typingElement || !cursorElement) return;
    
    const fullText = typingElement.dataset.text || '';
    
    // アニメーション設定
    const typingSpeed = 100;      // タイピング速度（ミリ秒/文字）
    const deletingSpeed = 50;     // 削除速度（ミリ秒/文字）
    const pauseAfterTyping = 3000; // タイピング完了後の待機時間
    const pauseAfterDeleting = 500; // 削除完了後の待機時間
    
    let currentIndex = 0;
    let isDeleting = false;
    let animationId: number | null = null;
    
    function updateText() {
      // 現在表示するテキストを取得
      const displayText = fullText.substring(0, currentIndex);
      
      // 最後の文字がピリオドの場合は特別なスタイルを適用
      if (displayText.length > 0 && displayText.length === fullText.length) {
        const mainText = displayText.slice(0, -1);
        const lastChar = displayText.slice(-1);
        typingElement.innerHTML = `${mainText}<span class="title-dot">${lastChar}</span>`;
      } else {
        typingElement.textContent = displayText;
      }
    }
    
    function animateTyping() {
      if (isDeleting) {
        // 削除中
        if (currentIndex > 0) {
          currentIndex--;
          updateText();
          animationId = window.setTimeout(animateTyping, deletingSpeed);
        } else {
          // 削除完了、タイピングモードに切り替え
          isDeleting = false;
          animationId = window.setTimeout(animateTyping, pauseAfterDeleting);
        }
      } else {
        // タイピング中
        if (currentIndex < fullText.length) {
          currentIndex++;
          updateText();
          animationId = window.setTimeout(animateTyping, typingSpeed);
        } else {
          // タイピング完了、削除モードに切り替え
          isDeleting = true;
          animationId = window.setTimeout(animateTyping, pauseAfterTyping);
        }
      }
    }
    
    // 既存のアニメーションをクリア（ページ遷移時の二重実行防止）
    if ((window as any).__typingAnimationId) {
      clearTimeout((window as any).__typingAnimationId);
    }
    
    // 少し遅延してからアニメーション開始
    (window as any).__typingAnimationId = window.setTimeout(animateTyping, 300);
  }
  
  // 初期化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTypingAnimation);
  } else {
    initTypingAnimation();
  }
  
  // Astroのビュートランジション対応
  document.addEventListener('astro:page-load', initTypingAnimation);
</script>
