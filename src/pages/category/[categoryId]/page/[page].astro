---
import { getArticles } from "@/libs/microcms/blog";
import type { GetStaticPathsOptions } from "astro";
import BlogList from "@/features/Blog/List/BlogList.astro";
import BlogListLayout from "@/layouts/BlogListLayout.astro";
import Pagination from "@/features/Pagination/Pagination.astro";
import { getCategories } from "@/libs/microcms/category";
import { BlogCategoryTabs } from "@/features/Blog/List/BlogCategoryTabs";
import type { Pagination as ArticlePagination } from "@/types/pagination";
import { CATEGORY_LIST } from "@/features/Blog/List/constants/categories";

export const prerender = true;

type Props = ArticlePagination;

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const categoriesRes = await getCategories();
  const categories = categoriesRes.contents;

  const articlesRes = await getArticles();
  const articles = articlesRes.contents;

  return categories.flatMap((c) => {
    const categorizedArticles = articles.filter((article) =>
      article.category.map((ac) => ac.id).includes(c.id)
    );
    return paginate(categorizedArticles, {
      params: { categoryId: c.id },
      pageSize: 10,
    });
  });
}

const { page } = Astro.props;
const categorizedArticles = page.data;

const categories = categorizedArticles.map((p) => p.category).flat();
const { categoryId } = Astro.params;
const category_of_this_page = categories.find((c) => c.id === categoryId);

// 全記事データを取得してカテゴリごとの記事数をカウント
const allArticlesRes = await getArticles();
const allArticles = allArticlesRes.contents;

const categoriesWithCount = CATEGORY_LIST.map(cat => {
  const count = allArticles.filter(article =>
    article.category.some(c => c.id === cat.id)
  ).length;
  return { ...cat, count };
});

const breadCrumbsList = [
  {
    name: "ホーム",
    path: `/`,
  },
  {
    name: "カテゴリー一覧",
    path: `/categories/`,
  },
  {
    name: category_of_this_page?.name || "カテゴリ",
    path: `/category/${categoryId}/page/1/`,
  },
];
---

<BlogListLayout 
  title={`${category_of_this_page?.name || "カテゴリ"} - ブログ記事一覧`}
  description={`${category_of_this_page?.name || "カテゴリ"}に関する記事一覧です`}
  {breadCrumbsList}
>
  <BlogCategoryTabs
    categories={categoriesWithCount}
    totalArticles={allArticles.length}
    currentCategoryId={categoryId}
    client:load
  />

  <h1 class="blog-list-title">
    <span class="category-name">{category_of_this_page?.name}</span>
    <span class="article-count">（全{page.total}件）</span>
  </h1>
  {page.lastPage > 1 && (
    <p class="page-info">
      {page.lastPage}ページ中 {page.currentPage}ページ目を表示
    </p>
  )}
  <BlogList articles={categorizedArticles} />
  <Pagination {page} />
</BlogListLayout>

<style>
  .blog-list-title {
    @apply text-2xl font-bold mb-4;
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }

  .category-name {
    color: #F3BC45;
  }

  .article-count {
    font-size: 1rem;
    color: #d1cfcf;
    font-weight: 500;
  }

  .page-info {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 1.5rem;
    padding-left: 0.25rem;
  }
</style>
