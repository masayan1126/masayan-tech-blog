---
import { getArticles } from "@/libs/microcms/blog";
import type { GetStaticPathsOptions } from "astro";
import BlogListLayout from "@/layouts/BlogListLayout.astro";
import Pagination from "@/features/Pagination/Pagination.astro";
import { BlogList } from "@/features/Blog/List/BlogList";
import { BlogListWithSearch } from "@/features/Blog/List/BlogListWithSearch";
import { BlogCategoryTabs } from "@/features/Blog/List/BlogCategoryTabs";
import type { Pagination as ArticlePagination } from "@/types/pagination";
import { CATEGORY_LIST } from "@/features/Blog/List/constants/categories";

type Props = ArticlePagination;

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const res = await getArticles();
  const posts = res.contents;

  return paginate(posts, {
    pageSize: 10,
  });
}

const { page } = Astro.props;
const articles = page.data;

// 全記事データを取得（検索用）
const allArticlesRes = await getArticles();
const allArticles = allArticlesRes.contents;

// 各カテゴリの記事数をカウント
const categoriesWithCount = CATEGORY_LIST.map(cat => {
  const count = allArticles.filter(article =>
    article.category.some(c => c.id === cat.id)
  ).length;
  return { ...cat, count };
});

const newArrivalPosts = [...articles].sort((a, b) => {
  return a.publishedAt > b.publishedAt ? -1 : 1;
});
---

<BlogListLayout>
  <BlogCategoryTabs
    categories={categoriesWithCount}
    totalArticles={allArticles.length}
    currentCategoryId={null}
    client:load
  />

  <!-- 検索機能付きブログリスト -->
  <BlogListWithSearch
    allArticles={allArticles}
    initialArticles={newArrivalPosts}
    currentPage={page.currentPage}
    totalPages={page.lastPage}
    totalArticles={page.total}
    pageSize={page.size}
    client:load
  />
</BlogListLayout>
