---
import BlogDetailLayout from "@/layouts/BlogDetailLayout.astro";
import { attachCodeHighlight } from "@/libs/codeHighlight";
import { getBlogs } from "@/libs/microcms/blog";

export async function getStaticPaths() {
  const res = await getBlogs();
  const posts = res.contents;
  return posts.map((post) => {
    return {
      params: { slug: post.id },
      props: post,
    };
  });
}

const post = Astro.props;
const { title, createdAt, publishedAt, updatedAt, description, eyecatch } =
  post;

const highlightedContent = attachCodeHighlight(post.content);

function extractTextFromTags(input: string, tagName: string) {
  const regex = new RegExp(`<${tagName}[^>]*>(.*?)<\/${tagName}>`, "g");
  const matches = [];
  let match;

  while ((match = regex.exec(input)) !== null) {
    matches.push(match[1]);
  }

  return matches;
}

const input = highlightedContent;

const tagName = "h2";
const tocArray = extractTextFromTags(input, tagName);
---

<BlogDetailLayout
  title={title}
  description={description}
  pubDate={new Date(publishedAt)}
  heroImage={eyecatch.url}
  categories={post.category}
  {tocArray}
>
  <p set:html={highlightedContent} />
</BlogDetailLayout>
