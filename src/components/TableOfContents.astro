---
import { extractHeadings } from "@/utils/extractHeadings";
import { Icon } from "astro-icon";

interface Props {
  content: string;
}

const { content } = Astro.props;
const headings = extractHeadings(content);

// h2の連番を事前計算
let h2Counter = 0;
const headingsWithIndex = headings.map((heading) => {
  if (heading.level === 2) {
    h2Counter++;
  }
  return { ...heading, h2Index: h2Counter };
});
---

{headingsWithIndex.length > 0 && (
  <div class="table-of-contents">
    <div class="toc-header">
      <Icon name="ph:list-bullets-bold" class="toc-header-icon" />
      <h3 class="toc-title">INDEX</h3>
      <span class="toc-subtitle">目次</span>
    </div>
    <nav class="toc-nav">
      <ul class="toc-list">
        {headingsWithIndex.map((heading) => (
          <li class={`toc-item ${heading.level === 3 ? 'toc-item-h3' : ''}`}>
            <a href={`#${heading.id}`} class={`toc-link ${heading.level === 3 ? 'toc-link-h3' : ''}`} data-level={heading.level}>
              {heading.level === 2 && (
                <span class="toc-number">{String(heading.h2Index).padStart(2, '0')}</span>
              )}
              <span class="toc-text">{heading.text}</span>
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </div>
)}

<style>
  .table-of-contents {
    background: var(--color-bg-secondary);
    border-radius: 8px;
    padding: 1.5rem;
    margin: 0 0 1.5rem 0;
    border: 1px solid var(--color-border);
  }

  .toc-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border);
  }

  .toc-header-icon {
    width: 18px;
    height: 18px;
    color: var(--color-primary);
  }

  .toc-title {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--color-primary);
    letter-spacing: 0.1em;
    margin: 0;
  }

  .toc-subtitle {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-left: auto;
  }

  .toc-nav {
    margin: 0;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .toc-item {
    margin: 0;
  }

  .toc-link {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    color: var(--color-text-muted);
    text-decoration: none;
    font-size: 0.85rem;
    line-height: 1.5;
    transition: all 0.2s ease;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    border-left: 2px solid transparent;
  }

  .toc-link:hover {
    color: var(--color-text);
    background: var(--color-bg-tertiary);
    border-left-color: rgba(var(--color-primary-rgb), 0.5);
  }

  .toc-number {
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--color-primary);
    opacity: 0.7;
    min-width: 1.25rem;
    padding-top: 0.125rem;
  }

  .toc-text {
    flex: 1;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* h3 の階層表示 */
  .toc-item-h3 {
    margin: 0;
  }

  .toc-link-h3 {
    padding-left: 2.5rem;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    opacity: 0.85;
    border-left: 2px solid transparent;
  }

  .toc-link-h3::before {
    content: '└';
    margin-right: 0.4rem;
    color: var(--color-text-muted);
    opacity: 0.4;
    font-size: 0.7rem;
  }

  .toc-link-h3:hover {
    opacity: 1;
  }

  .toc-link-h3.active {
    opacity: 1;
  }

  /* アクティブ状態（スクロール連動） */
  .toc-link.active {
    background: rgba(var(--color-primary-rgb), 0.1) !important;
    color: var(--color-primary) !important;
    border-left-color: var(--color-primary) !important;
    font-weight: 500;
  }

  .toc-link.active .toc-number {
    opacity: 1;
  }

  /* スムーズスクロールと固定ヘッダー対応 */
  html {
    scroll-behavior: smooth;
    scroll-padding-top: 120px;
  }

  /* モバイル表示時に目次の上にマージンを追加 */
  @media (max-width: 1024px) {
    .table-of-contents {
      margin-top: 2rem;
    }
  }
</style>

<script>
  // グローバルフラグで重複実行を防ぐ
  if ((window as any).tocHighlightSetup) {
    // すでにセットアップ済み
  } else {
    (window as any).tocHighlightSetup = true;
    setupTableOfContentsHighlight();
  }

  // スクロール連動で目次をハイライトする機能
  function setupTableOfContentsHighlight(): void {
    // 全ての目次リンクを取得（PC用とモバイル用の両方）
    const tocLinks = document.querySelectorAll('.toc-link');

    // H2・H3見出しを探す（article内から）
    let headings = document.querySelectorAll('article h2[id], article h3[id]');

    // articleの中に見出しがない場合は、より広範囲に探す
    if (headings.length === 0) {
      headings = document.querySelectorAll('h2[id], h3[id]');
    }

    if (tocLinks.length === 0 || headings.length === 0) {
      return;
    }

    // 現在アクティブな見出しID
    let currentActiveId = '';

    // Intersection Observerのオプション
    const observerOptions = {
      root: null,
      rootMargin: '-20% 0px -70% 0px', // 画面上部20%〜下部30%の範囲で判定
      threshold: 0
    };

    // 目次のリンクをアクティブにする関数
    const setActiveLink = (id: string): void => {
      if (currentActiveId === id) {
        return;
      }

      currentActiveId = id;

      // 全てのリンクからactiveクラスを削除
      const allTocLinks = document.querySelectorAll('.toc-link');
      allTocLinks.forEach(link => {
        link.classList.remove('active');
      });

      // 対応する全てのリンク（PC用とモバイル用）にactiveクラスを追加
      const selector = `.toc-link[href="#${id}"]`;
      const activeLinks = document.querySelectorAll(selector);

      activeLinks.forEach(link => {
        link.classList.add('active');
      });
    };

    // Intersection Observerのコールバック
    const observerCallback = (entries: IntersectionObserverEntry[]): void => {
      // 表示されている見出しを収集
      const visibleHeadings: Array<{id: string; top: number}> = [];

      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.getAttribute('id');
          if (id) {
            visibleHeadings.push({
              id: id,
              top: entry.boundingClientRect.top
            });
          }
        }
      });

      // 表示されている見出しの中で最も上にあるものをアクティブにする
      if (visibleHeadings.length > 0) {
        visibleHeadings.sort((a, b) => a.top - b.top);
        setActiveLink(visibleHeadings[0].id);
      }
    };

    // Observerを作成
    const observer = new IntersectionObserver(observerCallback, observerOptions);

    // 全てのH2・H3見出しを監視
    headings.forEach(heading => {
      observer.observe(heading);
    });

    // 初期状態の設定（requestAnimationFrameでバッチ処理して強制リフロー防止）
    requestAnimationFrame(() => {
      // まず全てのrect情報を一括で読み取り（読み取りフェーズ）
      const headingRects: Array<{id: string; top: number}> = [];
      const viewportHeight = window.innerHeight;

      headings.forEach(heading => {
        const rect = heading.getBoundingClientRect();
        const id = heading.getAttribute('id');
        if (id) {
          headingRects.push({ id, top: rect.top });
        }
      });

      // 書き込みフェーズ（DOMの変更）
      const visibleHeading = headingRects.find(
        h => h.top >= 0 && h.top <= viewportHeight * 0.5
      );

      if (visibleHeading) {
        setActiveLink(visibleHeading.id);
      } else if (headingRects.length > 0) {
        // どの見出しも表示されていない場合は最初の見出しをアクティブに
        setActiveLink(headingRects[0].id);
      }
    });
  }

  // Astroのビュー遷移対応
  document.addEventListener('astro:after-swap', () => {
    (window as any).tocHighlightSetup = false; // リセット
    setupTableOfContentsHighlight();
  });
</script>
