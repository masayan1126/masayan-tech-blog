---
import { extractHeadings } from "@/utils/extractHeadings";
import { Icon } from "astro-icon";

interface Props {
  content: string;
}

const { content } = Astro.props;
const headings = extractHeadings(content);
---

{headings.length > 0 && (
  <div class="table-of-contents">
    <h3 class="toc-title">
      <Icon name="noto:bookmark-tabs" class="w-5 h-5 mr-1 inline-block align-middle" />
      目次
    </h3>
    <nav class="toc-nav">
      <ul class="toc-list">
        {headings.map((heading) => (
          <li class="toc-item">
            <a href={`#${heading.id}`} class="toc-link">
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </div>
)}

<style>
  .table-of-contents {
    background: rgba(40, 40, 40, 0.8);
    border-radius: 8px;
    padding: 1.5rem;
    margin: 2rem 0;
    border-left: 4px solid #9ca3af;
    backdrop-filter: blur(8px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  /* スクロールバーのスタイリング */
  .toc-nav::-webkit-scrollbar {
    width: 6px;
  }

  .toc-nav::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }

  .toc-nav::-webkit-scrollbar-thumb {
    background: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
  }

  .toc-nav::-webkit-scrollbar-thumb:hover {
    background: rgba(156, 163, 175, 0.7);
  }

  .toc-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #d1d5db;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
  }

  .toc-nav {
    margin-left: 0.5rem;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin-bottom: 0.5rem;
  }

  .toc-link {
    color: #d1d5db;
    text-decoration: none;
    font-size: 0.95rem;
    line-height: 1.5;
    transition: all 0.3s ease;
    display: block;
    padding: 0.5rem 0.75rem;
    margin-left: -0.75rem;
    border-radius: 6px;
  }

  .toc-link:hover {
    color: #f9fafb;
    background: rgba(255, 255, 255, 0.05);
  }

  /* アクティブ状態（スクロール連動） */
  .toc-link.active {
    background: rgba(243, 188, 69, 0.25) !important;
    color: #F3BC45 !important;
    border-left: 3px solid #F3BC45 !important;
    padding-left: calc(0.75rem - 3px) !important;
    font-weight: 600 !important;
  }

  .toc-link:before {
    content: "▸ ";
    color: #9ca3af;
    margin-right: 0.5rem;
    transition: color 0.3s ease;
  }

  .toc-link.active:before {
    color: #F3BC45 !important;
  }

  /* スムーズスクロールと固定ヘッダー対応 */
  html {
    scroll-behavior: smooth;
    scroll-padding-top: 120px; /* 固定ヘッダーの高さ + 余白 */
  }
</style>

<script>
  // グローバルフラグで重複実行を防ぐ
  if ((window as any).tocHighlightSetup) {
    console.log('TOC: すでにセットアップ済みなのでスキップ');
  } else {
    (window as any).tocHighlightSetup = true;
    setupTableOfContentsHighlight();
  }

  // スクロール連動で目次をハイライトする機能
  function setupTableOfContentsHighlight(): void {
    console.log('=== TOC: setupTableOfContentsHighlight 開始 ===');
    
    // 全ての目次リンクを取得（PC用とモバイル用の両方）
    const tocLinks = document.querySelectorAll('.toc-link');
    console.log('TOC: tocLinks 数:', tocLinks.length);
    
    // H2見出しを探す（article内から）
    let headings = document.querySelectorAll('article h2[id]');
    console.log('TOC: article h2[id] の数:', headings.length);
    
    // articleの中に見出しがない場合は、より広範囲に探す
    if (headings.length === 0) {
      headings = document.querySelectorAll('h2[id]');
      console.log('TOC: h2[id] の数（広範囲）:', headings.length);
    }
    
    if (tocLinks.length === 0 || headings.length === 0) {
      console.warn('TOC: リンクまたは見出しが見つかりません');
      return;
    }

    // 現在アクティブな見出しID
    let currentActiveId = '';

    // Intersection Observerのオプション
    const observerOptions = {
      root: null,
      rootMargin: '-20% 0px -70% 0px', // 画面上部20%〜下部30%の範囲で判定
      threshold: 0
    };

    // 目次のリンクをアクティブにする関数
    const setActiveLink = (id: string): void => {
      console.log('TOC: setActiveLink 呼び出し:', id, '現在:', currentActiveId);
      
      if (currentActiveId === id) {
        console.log('TOC: すでにアクティブなのでスキップ');
        return;
      }
      
      currentActiveId = id;
      
      // 全てのリンクからactiveクラスを削除
      const allTocLinks = document.querySelectorAll('.toc-link');
      allTocLinks.forEach(link => {
        link.classList.remove('active');
      });
      console.log('TOC: 全てのリンクからactiveクラスを削除:', allTocLinks.length, '個');
      
      // 対応する全てのリンク（PC用とモバイル用）にactiveクラスを追加
      const selector = `.toc-link[href="#${id}"]`;
      console.log('TOC: セレクタ:', selector);
      const activeLinks = document.querySelectorAll(selector);
      console.log('TOC: activeLinks:', activeLinks.length, '個');
      
      activeLinks.forEach((link, index) => {
        link.classList.add('active');
        console.log(`TOC: activeクラスを追加[${index}]:`, link);
      });
      
      if (activeLinks.length === 0) {
        console.warn('TOC: activeLink が見つかりません');
      }
    };

    // Intersection Observerのコールバック
    const observerCallback = (entries: IntersectionObserverEntry[]): void => {
      console.log('TOC: Intersection Observer コールバック:', entries.length, 'エントリ');
      
      // 表示されている見出しを収集
      const visibleHeadings: Array<{id: string; top: number}> = [];
      
      entries.forEach(entry => {
        console.log('TOC: エントリ:', entry.target.id, 'isIntersecting:', entry.isIntersecting);
        if (entry.isIntersecting) {
          const id = entry.target.getAttribute('id');
          if (id) {
            visibleHeadings.push({
              id: id,
              top: entry.boundingClientRect.top
            });
          }
        }
      });
      
      console.log('TOC: 表示されている見出し:', visibleHeadings);
      
      // 表示されている見出しの中で最も上にあるものをアクティブにする
      if (visibleHeadings.length > 0) {
        visibleHeadings.sort((a, b) => a.top - b.top);
        console.log('TOC: 最上位の見出し:', visibleHeadings[0].id);
        setActiveLink(visibleHeadings[0].id);
      }
    };

    // Observerを作成
    console.log('TOC: Intersection Observer を作成');
    const observer = new IntersectionObserver(observerCallback, observerOptions);

    // 全てのH2見出しを監視
    console.log('TOC: 見出しの監視を開始');
    headings.forEach(heading => {
      observer.observe(heading);
      console.log('TOC: 監視開始:', heading.id);
    });

    // 初期状態の設定（少し遅延させる）
    setTimeout(() => {
      console.log('TOC: 初期状態の設定を開始');
      
      // 最初に表示されている見出しを探す
      for (let i = 0; i < headings.length; i++) {
        const heading = headings[i];
        const rect = heading.getBoundingClientRect();
        console.log(`TOC: 見出し[${i}] ${heading.id} の位置:`, rect.top);
        
        // 画面内に表示されているかチェック
        if (rect.top >= 0 && rect.top <= window.innerHeight * 0.5) {
          const id = heading.getAttribute('id');
          if (id) {
            console.log('TOC: 初期アクティブ見出し:', id);
            setActiveLink(id);
            break;
          }
        }
      }
      
      // どの見出しも表示されていない場合は最初の見出しをアクティブに
      if (!currentActiveId && headings.length > 0) {
        const firstId = headings[0].getAttribute('id');
        console.log('TOC: デフォルトで最初の見出しをアクティブに:', firstId);
        if (firstId) {
          setActiveLink(firstId);
        }
      }
    }, 300);
  }

  // Astroのビュー遷移対応
  document.addEventListener('astro:after-swap', () => {
    console.log('TOC: astro:after-swap イベント');
    (window as any).tocHighlightSetup = false; // リセット
    setupTableOfContentsHighlight();
  });
</script>
